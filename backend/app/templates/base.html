<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="x-api-key" content="{{ api_key or '' }}" />
  <title>Spending Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="icon" href="/static/favicon.ico" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Spending Tracker</a>
    <div>
      <a class="btn btn-outline-light me-2" href="/?month={{ month }}">Dashboard</a>
      <a class="btn btn-outline-light" href="/transactions?month={{ month }}">Transactions</a>
    </div>
  </div>
</nav>
<div class="container">
  {% block content %}{% endblock %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  document.addEventListener('submit', async function(e){
    const form = e.target.closest('.tx-form');
    if(!form) return;
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    // normalize amount and date
    if (typeof data.amount === 'string') data.amount = parseFloat(data.amount);
    try {
      const k = document.querySelector('meta[name="x-api-key"]')?.content;
      const headers = { 'Content-Type': 'application/json' };
      if (k) headers['X-API-Key'] = k;
      const res = await fetch('/api/v1/transactions/', {
        method: 'POST',
        headers,
        body: JSON.stringify(data)
      });
      if(!res.ok) throw new Error('Failed to save');
      const params = new URLSearchParams(window.location.search);
      const month = params.get('month');
      const url = month ? `${window.location.pathname}?month=${month}` : window.location.pathname;
      window.location.href = url;
    } catch(err) {
      alert('Error: ' + err.message);
    }
  });
})();
</script>
</body>
</html>
